---
title: "mBONITA analysis"
output: html_notebook
---

```{r}
require(UpSetR)
require(ggplot2)
require(ggsci)
require(ggpubr)
require(reshape2)
```


```{r}

reshapePvals <- function(mBonita_PA) {
  allPA <-
    reshape2::melt(
      mBonita_PA,
      id.vars = c("Pathway", "Method"),
      measure.vars =  c(
        "X1O2PlusCyA - X1O2NoCyA",
        "X1O2NoCyA - X19O2NoCyA",
        "X19O2NoCyA - X1O2PlusCyA"
      )
    )
  colnames(allPA) <-
    c("Pathway", "Method", "Contrast", "negativelog10pvalue")
  allPA$pvalue <- 10 ^ (-1 * allPA$negativelog10pvalue)
  allPA$FDR <- p.adjust(allPA$pvalue, method = "BH")
  allPA$negativelog10FDR <- (-1)*log10(allPA$FDR)
  temp <- allPA$pvalue < 0.05
  allPA <- allPA[temp,]
  return(allPA)
}
```

```{r}

concat_PA <- read.csv("pvalues_concatenated_20220816.csv", row.names = 1, col.names= c("Pathway", "Code", "Nodes", "X1O2PlusCyA - X1O2NoCyA", "X1O2NoCyA - X19O2NoCyA", "X19O2NoCyA - X1O2PlusCyA"), check.names = FALSE)
concat_PA$Method <- "Concatenated"
concat_PA <- reshapePvals(concat_PA)
prot_PA <- read.csv("pvalues_proteomics_20220816.csv", row.names = 1, col.names= c("Pathway", "Code", "Nodes", "X1O2PlusCyA - X1O2NoCyA", "X1O2NoCyA - X19O2NoCyA", "X19O2NoCyA - X1O2PlusCyA"), check.names = FALSE)
prot_PA$Method <- "Proteomics"
prot_PA <- reshapePvals(prot_PA)
trans_PA <- read.csv("pvalues_transcriptomics_20220816.csv", row.names = 1, col.names= c("Pathway", "Code", "Nodes", "X1O2PlusCyA - X1O2NoCyA", "X1O2NoCyA - X19O2NoCyA", "X19O2NoCyA - X1O2PlusCyA"), check.names = FALSE)
trans_PA$Method <- "Transcriptomics"
trans_PA <- reshapePvals(trans_PA)
phosph_PA <- read.csv("pvalues_phosphoproteomics_20220816.csv", row.names = 1, col.names= c("Pathway", "Code", "Nodes", "X1O2PlusCyA - X1O2NoCyA", "X1O2NoCyA - X19O2NoCyA", "X19O2NoCyA - X1O2PlusCyA"), check.names = FALSE)
phosph_PA$Method <- "Phosphoproteomics"
phosph_PA <- reshapePvals(phosph_PA)

```

```{r}
mBonita_PA <- rbind(concat_PA, prot_PA, trans_PA, phosph_PA)
write.csv(mBonita_PA, "mBonita_allResults.csv")
temp <- mBonita_PA$FDR < 0.05
mBonita_PA <- mBonita_PA[temp,]
head(mBonita_PA)
```
```{r}
ggplot(trans_PA) + geom_point(aes(x=negativelog10FDR, y=Pathway, color=Contrast)) + facet_wrap(facets = 'Method', drop=TRUE) + theme_bw()
ggsave(filename = "mBonita_trans_allResults.svg", width = 12, height = 10, units = 'in')
ggsave(filename = 'mBonita_trans_allResults.png', width = 12, height =10, units = 'in')
```

```{r}
require(ggplot2)

ggplot(mBonita_PA) + geom_point(aes(x=negativelog10FDR, y=Pathway, color=Contrast)) + facet_wrap(facets = 'Method', drop=TRUE) + theme_bw()
ggsave(filename = "mBonita_allResults.svg", width = 12, height = 10, units = 'in')
ggsave(filename = 'mBonita_allResults.png', width = 12, height =10, units = 'in')
```



```{r}
visList <- vector(mode = "list", length = length(unique(mBonita_PA$Method)))
names(visList) <- unique(mBonita_PA$Method)
for (n in names(visList)){
  visList[[n]] <- na.omit(mBonita_PA[mBonita_PA$Method %in% c(n), ])
}
unique(mBonita_PA$Contrast)

```
```{r}

makeMBonitaUpset <- function(contrast, visList){
  visList2 <- lapply(visList, function(x, contrast){return(as.vector(na.omit(x[x$Contrast == contrast,"Pathway"])))},contrast)
  p1 <- upset(fromList(visList2), order.by = c("freq", "degree"), mb.ratio = c(0.55, 0.45), empty.intersections = NULL, point.size = 5, line.size = 1 , mainbar.y.label = "Intersections", sets.x.label = "Pathways", text.scale = c(2,2, 2, 2, 2, 2), number.angles = 0, main.bar.color = 'black', sets.bar.color = 'black', shade.color = 'white', matrix.color = 'black')
  print(p1)
  png(filename = paste0('upset','_mBonita_',contrast,'.png'), width = 5, height = 8, pointsize = 14, res = 600, units = 'in')
  print(p1)
  dev.off()
}

```


```{r}
for (contrast in unique(mBonita_PA$Contrast)){
 makeMBonitaUpset(contrast, visList)
}

```

# Are the pathways of interest significant?

```{r}
pathways <- as.vector(read.table("PATHWAYS IN HIF1A NETWORK KEGG IDS.txt", header=FALSE, fill=TRUE)[,1])
print(pathways)
```

```{r}
gmt <- read.table('kegg_networks_edited.gmt', header=FALSE, fill=TRUE, sep = "\t")[,1:2]
colnames(gmt) <- c('Pathway', 'KEGGID')
gmt <- na.omit(gmt[gmt$KEGGID %in% pathways, c("KEGGID", "Pathway")])
rownames(gmt) <- gmt$KEGGID
print(gmt)
```
```{r}
head(mBonita_PA)
```

```{r, eval=TRUE}
PAlist2 <- reshape2::acast(mBonita_PA, Pathway ~ Method ~ Contrast, value.var = 'negativelog10FDR')
PAlist2[is.na(PAlist2)] <- 0
PAlist2 <- reshape2::melt(PAlist2)
colnames(PAlist2) <- c("Pathway", "Method", "Contrast", "negativelog10FDR")
PAlist2 <- na.omit(PAlist2[PAlist2$Pathway %in% gmt$Pathway[gmt$KEGGID %in% pathways],])
PAlist2
```
```{r}
require(ggsci)
require(ggpubr)
PAlist2$Significant <- as.factor(unlist(lapply(PAlist2$negativelog10FDR, function(x){if(x<1.303){return(FALSE)}else{return(TRUE)}})))
p1 <- ggplot(PAlist2, aes(Method, Pathway, fill=Significant)) + geom_tile(color = 'black', size = 0.3) + facet_wrap(~Contrast) + theme_pubr() + rotate_x_text(90) + scale_fill_brewer() + xlab("Dataset")
png(filename = "heatmap_mBonita_HIF1pathways.png", width = 10, height = 10, pointsize = 14, res = 600, units = 'in')
p1 
dev.off()
print(p1)
```

# Analyze node modulation score

```{r}



```



























